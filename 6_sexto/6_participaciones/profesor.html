<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Profesor</title>
    <link rel="stylesheet" href="../../resources/participaciones.css"> 

    <style>
        /* Oculta los contenedores de contenido */
        #app-content { display: none; }
        #access-denied { display: none; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script>
        // **TU CONFIGURACIÓN DE FIREBASE COPIADA DE LA CONSOLA**
        const firebaseConfig = {
            apiKey: "AIzaSyDCPRHjRZT8NrpedBE33u1KWQIZQjPuwa0",
            authDomain: "cepia-primaria.firebaseapp.com",
            projectId: "cepia-primaria",
            storageBucket: "cepia-primaria.appspot.com",
            messagingSenderId: "101283432429",
            appId: "1:101283432429:web:7af3e8a79630e853fb49e4"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Determina dinámicamente el nombre del grupo (Colección en Firestore)
        const pathParts = window.location.pathname.split('/').filter(part => part !== '');
        const groupName = pathParts[pathParts.length - 2] || 'default_group'; 
        const classCollection = db.collection(groupName);

        // Variables y funciones necesarias
        let estudiantes = [];
        window.modificarParticipacion = modificarParticipacion;
        window.agregarParticipacionDirecto = agregarParticipacionDirecto;
        window.restarParticipacionDirecto = restarParticipacionDirecto;
        window.eliminarEstudiante = eliminarEstudiante;
    </script>
</head>
<body>

    <script>
        // --- DEFINE TU CONTRASEÑA AQUÍ ---
        const CORRECT_PASSWORD = 'admin'; // ¡Cambia 'admin' por tu código de acceso!

        let isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';

        // Si no está autenticado en esta sesión, pedir contraseña
        if (!isAuthenticated) {
            const userPassword = prompt('Por favor, ingresa el código de acceso:');
            
            if (userPassword === CORRECT_PASSWORD) {
                isAuthenticated = true;
                sessionStorage.setItem('isAuthenticated', 'true'); // Guarda para esta sesión
            } else {
                alert('Código incorrecto. Acceso denegado.');
            }
        }

        // Mostrar el contenido correcto basado en la autenticación
        if (isAuthenticated) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('app-content').style.display = 'block';
            });
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('access-denied').style.display = 'block';
            });
        }
    </script>

    <div id="access-denied" style="text-align: center; margin-top: 50px;">
        <h1>Acceso Denegado</h1>
        <p>El código de acceso es incorrecto.</p>
    </div>

    <div id="app-content">
        <div class="container">
            <header>
                <h1>Panel de Control del Profesor Sexto</h1>
                <p class="description">Gestión de participaciones estudiantiles</p>
            </header>

            <div class="card">
                <h2 class="card-title">Agregar Estudiante</h2>
                <form id="estudianteForm">
                    <div class="form-row">
                        <div class="form-group"><label for="numeroLista">Número de Lista</label><input type="number" id="numeroLista" min="1" required></div>
                        <div class="form-group"><label for="apellidoPaterno">Apellido Paterno</label><input type="text" id="apellidoPaterno" required></div>
                        <div class="form-group"><label for="apellidoMaterno">Apellido Materno</label><input type="text" id="apellidoMaterno" required></div>
                        <div class="form-group"><label for="nombre">Nombre(s)</label><input type="text" id="nombre" required></div>
                    </div>
                    <button type="submit" class="btn btn-success">Agregar Estudiante</button>
                </form>
            </div>
            
            <div class="card">
                <h2 class="card-title">Registrar Participación por Número de Lista</h2>
                <div id="participacionControl">
                    <div class="form-group"><label for="numeroListaParticipacion">Número de Lista</label><input type="number" id="numeroListaParticipacion" min="1" required></div>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="modificarParticipacion(1)">Agregar (+1)</button>
                        <button class="btn btn-warning" onclick="modificarParticipacion(-1)">Restar (-1)</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Participaciones Registradas</h2>
                <div class="table-container">
                    <table id="tablaEstudiantes">
                        <thead><tr><th>N° Lista</th><th>Nombre Completo</th><th>Participaciones</th><th>Acciones</th></tr></thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
                <div id="mensajeVacio" class="empty-message">No hay estudiantes registrados.</div>
            </div>
        </div>

        <script>
            // Referencias a los elementos del DOM
            const estudianteForm = document.getElementById('estudianteForm');
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            const mensajeVacio = document.getElementById('mensajeVacio');

            document.addEventListener('DOMContentLoaded', () => {
                // Escucha cambios en tiempo real en la colección
                classCollection.orderBy('numeroLista').onSnapshot(snapshot => {
                    estudiantes = snapshot.docs.map(doc => ({
                        id: doc.id, 
                        ...doc.data()
                    }));
                    actualizarTabla(); // Redibuja la tabla con los datos actualizados
                }, error => {
                    console.error("Error al leer Firestore:", error);
                });

                // Manejo del formulario para agregar estudiantes
                estudianteForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const numeroLista = parseInt(document.getElementById('numeroLista').value);
                    const numeroListaStr = String(numeroLista);
                    
                    const docRef = classCollection.doc(numeroListaStr);
                    const doc = await docRef.get();

                    if (doc.exists) {
                        alert('Ya existe un estudiante con ese número de lista.');
                        return;
                    }

                    const nuevoEstudiante = {
                        numeroLista,
                        apellidoPaterno: document.getElementById('apellidoPaterno').value.trim(),
                        apellidoMaterno: document.getElementById('apellidoMaterno').value.trim(),
                        nombre: document.getElementById('nombre').value.trim(),
                        participaciones: 0
                    };

                    try {
                        // El numeroLista será usado como ID del documento en Firestore
                        await docRef.set(nuevoEstudiante); 
                        estudianteForm.reset();
                    } catch (error) {
                        console.error("Error al agregar documento:", error);
                        alert("Hubo un error al agregar el estudiante.");
                    }
                });
            });
            
            // Modificación de Participación (Input principal)
            async function modificarParticipacion(cantidad) {
                const inputEl = document.getElementById('numeroListaParticipacion');
                if (!inputEl.value) { alert('Por favor, introduce un número de lista.'); return; }
                const numeroLista = String(parseInt(inputEl.value));
                
                try {
                    const docRef = classCollection.doc(numeroLista);
                    const doc = await docRef.get();

                    if (doc.exists) {
                        const currentCount = doc.data().participaciones;
                        const newCount = Math.max(0, currentCount + cantidad);

                        await docRef.update({ participaciones: newCount });
                        inputEl.value = '';
                        
                        const est = estudiantes.find(e => e.id === numeroLista); 
                        const nombreCompleto = est ? `${est.nombre} ${est.apellidoPaterno}` : 'Estudiante';
                        const accion = cantidad > 0 ? 'agregada para' : 'restada a';
                        alert(`Participación ${accion} ${nombreCompleto}. Total: ${newCount}`);
                    } else {
                        alert('No se encontró un estudiante con ese número de lista.');
                    }
                } catch (error) {
                    console.error("Error al modificar participación:", error);
                    alert("Hubo un error al modificar la participación.");
                }
            }

            // Modificación de Participación Directa (Botones de la tabla)
            async function agregarParticipacionDirecto(numeroLista) {
                const docRef = classCollection.doc(String(numeroLista));
                try {
                    await docRef.update({
                        participaciones: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (error) {
                    console.error("Error al agregar participación directa:", error);
                }
            }
            
            async function restarParticipacionDirecto(numeroLista) {
                const docRef = classCollection.doc(String(numeroLista));
                try {
                    const doc = await docRef.get();
                    if (doc.exists && doc.data().participaciones > 0) {
                        await docRef.update({
                            participaciones: firebase.firestore.FieldValue.increment(-1)
                        });
                    }
                } catch (error) {
                    console.error("Error al restar participación directa:", error);
                }
            }

            // Eliminar Estudiante
            async function eliminarEstudiante(numeroLista) {
                if (confirm('¿Estás seguro de que deseas eliminar a este estudiante?')) {
                    try {
                        await classCollection.doc(String(numeroLista)).delete();
                    } catch (error) {
                        console.error("Error al eliminar estudiante:", error);
                        alert("Hubo un error al eliminar el estudiante.");
                    }
                }
            }
            
            // Dibuja la tabla con los datos que ya están en la variable 'estudiantes'
            function actualizarTabla() {
                cuerpoTabla.innerHTML = '';
                mensajeVacio.style.display = estudiantes.length === 0 ? 'block' : 'none';
                
                const estudiantesOrdenados = [...estudiantes].sort((a, b) => a.numeroLista - b.numeroLista);
                
                estudiantesOrdenados.forEach(est => {
                    const nombreCompleto = `${est.apellidoPaterno} ${est.apellidoMaterno} ${est.nombre}`;
                    cuerpoTabla.innerHTML += `
                        <tr>
                            <td>${est.numeroLista}</td>
                            <td>${nombreCompleto}</td>
                            <td><span class="participacion-count">${est.participaciones}</span></td>
                            <td class="actions">
                                <button class="btn btn-small btn-success" onclick="agregarParticipacionDirecto(${est.numeroLista})">+1</button>
                                <button class="btn btn-small btn-warning" onclick="restarParticipacionDirecto(${est.numeroLista})">-1</button>
                                <button class="btn btn-small btn-danger" onclick="eliminarEstudiante(${est.numeroLista})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            }
        </script>
    </div> 
</body>
</html>